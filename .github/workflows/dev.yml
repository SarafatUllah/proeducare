# # Deploy to aws
# name: Deploy Dev to AWS

# # Controls when the action will run.
# on:
#   workflow_dispatch:
#   push:
#     branches: [dev]

# env:
#   SERVER_IP: 139.59.193.155
#   USERNAME: devxhub

#   NUXT_PUBLIC_SITE_URL: "https://proeducare.com/"
#   NUXT_PUBLIC_APP_NAME: "ProEdu Care"
#   NUXT_PUBLIC_API_URL: "https://lms-api.devxhub.com/api"
#   NUXT_PUBLIC_WORKFLOW: "dev"
#   NUXT_PUBLIC_RECAPTCHA_SITE_KEY: "6LdhO5gpAAAAAMnkhzxfDnWw6UKGvbmruGtQNSc7"
#   NUXT_PUBLIC_PUSHER_APP_KEY: "Zm9E7P1K0r67vMVE7W1kOPMvXMeUxy"
#   NUXT_PUBLIC_PUSHER_HOST: "socket.devxhub.com"
#   NUXT_PUBLIC_PUSHER_PORT: 443

# # A workflow run is made up of one or more jobs that can run sequentially or in parallel
# jobs:
#   build:
#     runs-on: ubuntu-latest

#     # Steps represent a sequence of tasks that will be executed as part of the job
#     steps:
#       - name: Checkout 🛎
#         uses: actions/checkout@v3

#       - name: Setup node env 🏗
#         uses: actions/setup-node@v3
#         with:
#           node-version: 20
#           check-latest: true

#       - name: Get yarn cache directory path
#         id: yarn-cache-dir-path
#         run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

#       - uses: actions/cache@v3
#         id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
#         with:
#           path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
#           key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
#           restore-keys: |
#             ${{ runner.os }}-yarn-

#       - name: Install dependencies 👨🏻‍💻
#         run: yarn install --prefer-offline --frozen-lockfile --non-interactive --production=false

#       - name: Make envfile
#         uses: SpicyPizza/create-envfile@v1.3
#         with:
#           envkey_GIT_COMMIT_SHA: ${{ github.sha }}
#           envkey_NUXT_PUBLIC_SITE_URL: ${{ env.NUXT_PUBLIC_SITE_URL }}
#           envkey_NUXT_PUBLIC_APP_NAME: "${{ env.NUXT_PUBLIC_APP_NAME }}"
#           envkey_NUXT_PUBLIC_WORKFLOW: ${{ env.NUXT_PUBLIC_WORKFLOW }}
#           envkey_NUXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ env.NUXT_PUBLIC_RECAPTCHA_SITE_KEY }}
#           envkey_NUXT_PUBLIC_PUSHER_APP_KEY: ${{ env.NUXT_PUBLIC_PUSHER_APP_KEY }}
#           envkey_NUXT_PUBLIC_PUSHER_HOST: ${{ env.NUXT_PUBLIC_PUSHER_HOST }}
#           envkey_NUXT_PUBLIC_PUSHER_PORT: ${{ env.NUXT_PUBLIC_PUSHER_PORT }}

#       - name: Run builder
#         run: yarn build

#       - name: Archive necessary folders and files
#         uses: montudor/action-zip@v1
#         with:
#           args: zip -r dist.zip .output .env ecosystem.config.js

#       - name: Install SSH key
#         uses: shimataro/ssh-key-action@v2
#         with:
#           key: ${{ secrets.SSH_KEY }}
#           known_hosts: ${{ env.SERVER_IP }}

#       - name: Adding Known hosts
#         run: ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

#       - name: Rsync over ssh
#         run: rsync -avz dist.zip ${{ env.USERNAME }}@${{ env.SERVER_IP }}:/home/${{ env.USERNAME }}

#       - name: Executing remote ssh commands using ssh key
#         uses: appleboy/ssh-action@master
#         env:
#           SHA: ${{ github.sha }}
#           USERNAME: ${{ env.USERNAME }}
#           APP_NAME: devxhub
#         with:
#           host: ${{ env.SERVER_IP }}
#           username: ${{ env.USERNAME }}
#           key: ${{ secrets.SSH_KEY }}
#           envs: USERNAME,APP_NAME
#           script: |
#             export PATH="/home/devxhub/.local/share/fnm:$PATH"
#             eval "`fnm env`"
#             source ~/.bashrc
#             echo $PATH
#             find /home/devxhub/lms -mindepth 1 -delete
#             echo "Directory cleaned..."
#             mv dist.zip /home/devxhub/lms/
#             echo "dist folder copied..."
#             cd /home/devxhub/lms
#             echo "Now at application directory..."
#             unzip dist.zip
#             echo "unzip done..."
#             if pm2 show lms; then
#               pm2 restart lms
#             else
#               pm2 start --only lms
#             fi
#             sudo rm -rf /var/cache/lms/*
